<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>GeoAR.js demo</title>
  <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
  <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
</head>

<body style="margin: 0; overflow: hidden;">
  <a-scene vr-mode-ui="enabled: false" embedded arjs="sourceType: webcam; debugUIEnabled: false;">

    <!-- Image assets generated in java script -->
    <a-assets>
    </a-assets>

    <!-- Camera -->
    <a-camera gps-camera rotation-reader>

      <!-- Camera HUD -->
      <a-entity id="cameraHUD" geometry="primitive: plane; height: 0.15; width: 1" position="0 0.35 -1"
        material="color: white;" visible="false">
        <a-text id="cameraHUD_POIName" color="black" opacity="1" position="-0.1 0.015 0.0"
          scale="0.2 0.2 0.2" zOffset="0.001">
          ></a-text>
        <a-text id="cameraHUD_POIDistance" value="100m" color="black" opacity="1" position="-0.1 -0.038 0.0"
          scale="0.2 0.2 0.2" zOffset="0.001">
          ></a-text>
        <a-image id="cameraHUD_POIImage" position="-0.2 0.0 0.0" scale="0.15 0.15 0.15" src="#lekplatsen_img"></a-image>
      </a-entity>

    </a-camera>
  </a-scene>
</body>
<script>

  let POIs = [
    {
      displayName: 'Lekplatsen',
      img: './assets/lekplatsen.jpg',
      location: {
        lat: 56.837500,
        lng: 12.601533,
      }
    },
    {
      displayName: 'Midsommarstang',
      img: './assets/midsommar.jpg',
      location: {
        lat: 56.835922,
        lng: 12.600683,
      }
    },
    {
      displayName: 'Fiskar-Erik',
      img: './assets/fiskarerik.jpg',
      location: {
        lat: 56.833074,
        lng: 12.587764,
      }
    },
    {
      displayName: 'Livbojen',
      img: './assets/livbojen.jpg',
      location: {
        lat: 56.830317,
        lng: 12.597824,
      }
    },
    {
      displayName: 'Utsikten',
      img: './assets/utsikten.jpg',
      location: {
        lat: 56.835808,
        lng: 12.589898,
      }
    },
    {
      displayName: 'Brunnslocket',
      img: './assets/brunnslocket.jpg',
      location: {
        lat: 56.835719,
        lng: 12.606796,
      }
    },
    {
      displayName: 'Groddammen',
      img: './assets/groddammen.jpg',
      location: {
        lat: 56.832754,
        lng: 12.599374,
      }
    },
    {
      displayName: 'Stenen',
      img: './assets/stenen.jpg',
      location: {
        lat: 56.836265,
        lng: 12.583309,
      }
    },
  ];

  function uuidv4() {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
      var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
      return v.toString(16);
    });
  }

  let cameraHUD = null;
  let cameraHUD_POIName = null;
  let cameraHUD_POIDistance = null;
  let cameraHUD_POIImage = null;

  window.onload = () => {

    cameraHUD = document.getElementById('cameraHUD');
    cameraHUD_POIName = document.getElementById('cameraHUD_POIName');
    cameraHUD_POIDistance = document.getElementById('cameraHUD_POIDistance');
    cameraHUD_POIImage = document.getElementById('cameraHUD_POIImage');

    addPlacesToScene(POIs);

  };

  function addPlacesToScene(POIs) {
    let scene = document.querySelector('a-scene');
    let assets = document.querySelector('a-assets');

    POIs.forEach((POI) => {

      let entity = document.createElement('a-entity');

      // set a scene unique name for each POI 
      POI.name = uuidv4();

      let latitude = POI.location.lat;
      let longitude = POI.location.lng;

      entity.setAttribute('gps-entity-place', `latitude: ${latitude}; longitude: ${longitude};`);
      entity.setAttribute('scale', '80 80 80');
      entity.setAttribute('look-at', '[gps-camera]');
      entity.setAttribute('id', POI.name);

      // create image asset
      let imageAsset = document.createElement('img');
      let imageAssetID = POI.name + "_img";
      imageAsset.setAttribute('src', POI.img);
      imageAsset.setAttribute('id', imageAssetID);

      // create image entity
      let image = document.createElement('a-image');
      image.setAttribute('src', "#" + imageAssetID);

      // create text entity
      let text = document.createElement('a-text');
      text.setAttribute('id', POI.name + 'Distance');
      text.setAttribute('value', 'far');
      text.setAttribute('color', '#efefef');
      text.setAttribute('position', '-0.3 -0.3 0.5');
      text.setAttribute('zOffset', '0.001');

      // add to sscene
      assets.appendChild(imageAsset);
      entity.appendChild(image);
      entity.appendChild(text);
      entity.addEventListener('loaded', () => {
        window.dispatchEvent(new CustomEvent('gps-entity-place-loaded'))
      });

      scene.appendChild(entity);
    });

    function updateDistances() {

      let POINearby = false;

      POIs.forEach((POI) => {
        let entity = document.getElementById(POI.name);

        if (entity != null) {
          const distanceMsg = entity.getAttribute('distanceMsg');
          let distMsgArray = distanceMsg.split(" "); // follows format "number unit"
          let distance = distMsgArray[0];
          let unit = distMsgArray[1];
          let displayUnit = "m";

          if (unit === "kilometers") {
            displayUnit = "km";
          }
          document.getElementById(POI.name + 'Distance').setAttribute("value", distance + displayUnit);

          if (parseInt(distance) < 50 && displayUnit === "m") {
            // nearby, show info on camera HUD             
            POINearby = true;
            cameraHUD.setAttribute("visible", true);
            cameraHUD_POIName.setAttribute("value", POI.displayName);
            cameraHUD_POIDistance.setAttribute("value", dist + "m");
            cameraHUD_POIImage.setAttribute("src", '#' + POI.img);

            // remove entity from scene 
            entity.parentNode.removeChild(entity);
          } else {
            entity.setAttribute("visible", true);
            console.log('show ' + POI.name);
          }

        }
      });

      if (POINearby == false) {
        cameraHUD.setAttribute("visible", false);
      }
    }

    let t = 0;
    function render() {
      t += 1;
      if (t > 100) { // todo: change to update every second
        t = 0;
        updateDistances();
      }
      requestAnimationFrame(render);

    }
    render();

  }
</script>

</html>